title: 利用WeixinJSBridge，控制分享到朋友圈和转发给好友的行为
date: 2014-12-04 20:21
categories: 微信开发 
---
在微信里，可以改变“分享到朋友圈”和“转发给好友”的默认行为。这些js接口，在微信6.0之前的版本还是不公开的，官方文档里未提及，但是其实借助WeixinJSBridge可以做到；从微信6.0之后，微信官方提供了JSSDK，可以直接使用这些接口
<!--more-->

# 分享行为

可以控制以下几种行为

## 缩略图

默认是微信自动截取当前页面中第一张大图，也就是<img>标签，而且width要超过一定的值。display:none和background-image是不算的，只能是<img>标签

但是通过传递参数，可以自己指定一张图片

## 分享页面

默认分享的是当前页面，通过定制，可以指定一个URL，点击后会跳转到此URL

## 标题

分享文本的标题，只对“转发给好友”有效，“分享到朋友圈”不显示标题。默认会取当前页面的title的内容，可以设置成任意文本

## 内容

分享文本的内容。在“转发给好友”时，默认是当前页面的URL。在“分享到朋友圈”时，默认是title的内容，可以设置成任意文本

## 左下角的小签名

在朋友圈看不到（但是从APP里调用SDK分享到朋友圈，可以显示），“转发给好友”可以在左下角看到

这个行为比较复杂，如果转发的是一个图文消息，就是链接是mp.weixin.qq.com/s?__biz=xxxx这种的，左下角默认会带公众号的名字，但是不会有图片；如果是一个外链，则默认不会有签名

但是可以通过设置app_id，来改变默认行为，显示签名。有趣的是，这里的app_id可以任意填，只要你能知道。而且如果填的是公众号的app_id，就不会有图片，图片的位置是一个白色小方块；如果填的是腾讯开放平台的app_id，就会带上一个图片

# 回调行为

分享到朋友圈，和转发给好友之后，其实在页面里都会得到js回调，而且是不同的回调，比如开始转发，取消转发，转发成功，每个阶段都会有回调函数。这个小秘密有时候非常有用，因为开发者就可以控制转发之后的行为。但是微信本身的态度是不鼓励引导分享，强制分享的，所以这些接口一直没有公开，而且或许有一天突然就被封了也说不定。毕竟不是没有先例，曾经连关注公众号都是有JS API了，现在早就不能用了

另外，android版的微信有BUG，只要用户点了转发到朋友圈，回调就会立刻被调用，不管之后用户是否真的分享，应该是android版微信的BUG，这个版本至今也没有修复。iOS版的微信没有这个BUG，所有回调都可以正确执行

# lib

可以直接通过WeixinJSBridge实现本文说的功能，但是显然有更好的办法，用WeixinAPI这个第三方库，可以更容易地实现这些功能，在github上就可以找到，以下是最简单的示例代码，详细的文档见主页说明

时至今日，由于微信已经公开了这些js sdk，所以第三方库没有意义了

```
var wxData = {
    "title": "标题写在这里",
    "link": "www.baidu.com",
    "appId": "your app_id",
    "desc": "the desc"
};

var wxCallbacks = {
    confirm: function(resp) {
        // 当用户点击分享到朋友圈，就会触发此回调
    }
};

Api.shareToTimeline(wxData, wxCallbacks);
Api.shareToFriend(wxData, {});
```